<!DOCTYPE html>
<html>

<head>
    <title>Goods.com</title>

    <link rel="stylesheet" type="text/css" href="assets/style.css"/>
    
    <style>

       #trackingId 
       {
        width: 600px; /* Adjust the width as needed */
       }

        #map 
        {
            text-align: center;
        }

        iframe 
        {
            max-width: 100%;
            width: 100vh;
            height: 50vh;
        }

        #details 
        {
          text-align: center;
        }

        #stopButton 
        {
          text-align: center;
        
        }

        
    </style>
    
</head>

<body>

<div class="navBar">
    <img id="logo" src="assets/goods_logo.png" alt="alternative text"/>

    <input type="text" id="trackingId" placeholder="Enter Tracking ID" />
    <button type="button" onclick="startTracking()">Start Tracking</button>

    <!--
      <input type="text" placeholder="Search for products in goods.com" />
    <button type="submit">Search<i class="fa-search"></i></button>
    -->

    <div id="listing">
        <ul>
            <a href="/account.html">Account</a>
            <a href="/cart.html">Cart</a>
            <a href="/monitor.html">Your orders</a>
            <a href="/index.html"> Main </a>
            <a href="/geoLocation.html"> Tracking </a>
        </ul>
    </div>
</div>

<br>

<div id="map"></div>

<div id="stopButton">
  <button onclick="buttonClickHandler()">Stop watching location</button>
</div>

<div id="details"></div>


<script>

var reqCount=0;

//Need to supply tracking id before proceeding to find package location
//Doesn't yet require a specific tracking id associated with the individual
async function startTracking() {
    var trackingId = document.getElementById("trackingId").value;
  //
    if (trackingId) {
        try {
            // Use fetch to get tracking codes from the server
            const response = await fetch('/trackingCODES');
            
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }

            const trackingCodes = await response.json();

            if (trackingCodes.includes(trackingId)) {
                console.log("Geolocation updates started with Tracking ID: " + trackingId);
                watchId = navigator.geolocation.watchPosition(position => scrollmap(position, trackingCodes), handleError, options);
            } else {
                alert("Invalid Tracking ID. Please enter a valid Tracking ID.");
            }
        } catch (error) {
            console.error("Error fetching tracking codes:", error);
            alert("Error fetching tracking codes. Please try again.");
        }
    } else {
        alert("Please enter a Tracking ID before starting tracking.");
    }
}

//const watchId = navigator.geolocation.watchPosition(scrollmap,handleError,options);

function scrollmap(position)
{
  //USE OPTION+COMMAND+C TO VIEW CONSOLE AND SEE OUTPUTS IN BROWSER
    const {latitude,longitude} = position.coords;

    console.log("Latitude: ");
    console.log(latitude);
    console.log("\n");
    console.log("Longitude: ");
    console.log(longitude);
    console.log("\n");
    
    //Show a map centered at latitude / longitude.
    map.innerHTML = '<iframe width="700" height="300" src="https://maps.google.com/maps?q='+latitude+','+longitude+'&amp;z=15&amp;output=embed"></iframe>';

    reqCount++;
    details.innerHTML = "Latitude:" + latitude + "<br>"+"Longitude:" + longitude + "<br>" + "request count:" + reqCount;

}

function buttonClickHandler() {
  // Cancel the updates when the user clicks a button.
  navigator.geolocation.clearWatch(watchId);
  console.log("Geolocation updates stopped by the user.");
}

function handleError(error) {
  // Display error based on the error code.
  const { code } = error;
  switch (code) {
    case GeolocationPositionError.TIMEOUT:
      // Handle timeout.
      break;
    case GeolocationPositionError.PERMISSION_DENIED:
      // User denied the request.
      break;
    case GeolocationPositionError.POSITION_UNAVAILABLE:
      // Position not available.
      break;
  }
}

var options = {
    enableHighAccuracy: false,
    timeout: 5000,
    maximumAge: 0
};


</script>

</body>

</html>